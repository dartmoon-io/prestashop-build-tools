#!/usr/bin/env php
<?php

/*
 * This file is part of the dartmoon/prestashop-build-tools package.
 *
 * Copyright (c) 2021 Dartmoon <hello@dartmoon.io>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

foreach ([__DIR__ . '/../../../autoload.php', __DIR__ . '/../vendor/autoload.php'] as $file) {
    if (file_exists($file)) {
        require $file;
        break;
    }
}

$workingDir = getcwd();
$configDir = $workingDir . '/build-tools';
$vendorDir = $workingDir . '/vendor';
$vendorPrefixedDir = $workingDir . '/vendor_prefixed';
$phpScoperBin = __DIR__ . '/../../../bin/php-scoper';
$phpScoperConfig = __DIR__ . '/../scoper.inc.php';
$rootComposerJson = json_decode(file_get_contents($workingDir . '/composer.json'), true);
$prefix = $rootComposerJson['extra']['build-tools']['prefix'];

// Let's check whether the php-scoper binary exists,
// if not this package is used standalone
if (!file_exists($phpScoperBin)) {
    $phpScoperBin = __DIR__ . '/../vendor/bin/php-scoper';
}

// Let's check whether the user ovverrided the scoper.inc.php
// placing a config file into /build-tools folder of the project
if (file_exists($configDir . '/scoper.inc.php')) {
    $phpScoperConfig = $configDir . '/scoper.inc.php';
}

// Start with a clean vendor_prefixed directory
shell_exec("rm -rf {$vendorPrefixedDir}");
shell_exec("mkdir -p {$vendorPrefixedDir}");

// So php-scoper do not retain the directory structure given
// by composer (vendor_name/package_name). To overcome this
// we are going to trick it putting an empty txt file inside
// the vendor folder. With this the "common path" of all vendors
// is exactly the vendor folder and so the directory structure is preserved
if (!file_exists($vendorDir . '/build-tools.txt')) {
    copy(__DIR__ . '/../build-tools.txt', $vendorDir . '/build-tools.txt');
}

// Let's prefix the vendors using php-scoper
shell_exec("{$phpScoperBin} add-prefix --working-dir={$workingDir} --config={$phpScoperConfig} --prefix=\"{$prefix}\" --output-dir={$vendorPrefixedDir} --force");

// Let's dump the autolader
shell_exec("composer dump-autoload --working-dir={$workingDir} --quiet");