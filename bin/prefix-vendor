#!/usr/bin/env php
<?php

/*
 * This file is part of the dartmoon/prestashop-build-tools package.
 *
 * Copyright (c) 2017 Dartmoon <hello@dartmoon.io>,
 *                    Alessandro Pasqualini <alessandro@dartmoon.io>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

foreach ([__DIR__ . '/../../../autoload.php', __DIR__ . '/../vendor/autoload.php'] as $file) {
    if (file_exists($file)) {
        require $file;
        echo "$file";
        break;
    }
}

$workingDir = getcwd();
$configDir = $workingDir . '/build-tools';
$phpScoperConfigDir = $configDir . '/php-scoper';
$vendorPrefixedDir = $workingDir . '/vendor_prefixed';

// Let's find the binary of php-scoper
$phpScoper = __DIR__ . '/../../../bin/php-scoper';
if (!file_exists($phpScoper)) {
    $phpScoper = __DIR__ . '/../vendor/bin/php-scoper';
}

// Start with a clean vendor_prefixed directory
shell_exec("rm -rf {$vendorPrefixedDir}");
shell_exec("mkdir -p {$vendorPrefixedDir}");

// For each vendor we need to prefix it,
// mantaining the structure of the vendor
// generated by composers
$vendors = glob("{$phpScoperConfigDir}/*", GLOB_ONLYDIR);
foreach ($vendors as $vendor) {
    $vendorName = basename($vendor); // Get the vendor name from the directory name
    
    // Let's prefix each package
    $packages = glob("{$vendor}/*.inc.php");
    foreach ($packages as $package) {
        $packageName = basename($package, '.inc.php');
        shell_exec("{$phpScoper} add-prefix --working-dir={$workingDir} --config={$package} --output-dir={$vendorPrefixedDir}/{$vendorName}/{$packageName} --force --quiet");
    }
}

// Let's dump the autolader
shell_exec("composer dump-autoload --working-dir={$workingDir} --classmap-authoritative --quiet");